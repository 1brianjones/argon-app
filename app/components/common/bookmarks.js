"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var application = require("application");
var applicationSettings = require("application-settings");
var observable_array_1 = require("data/observable-array");
var observable_1 = require("data/observable");
var Argon = require("@argonjs/argon");
var BookmarkItem = (function (_super) {
    __extends(BookmarkItem, _super);
    function BookmarkItem(item) {
        var _this = _super.call(this, item) || this;
        _this.builtin = false;
        var uri = item.uri;
        // reuse an existing BookmarkItem if one exists
        if (historyMap.has(uri))
            return historyMap.get(uri);
        if (realityMap.has(uri))
            return realityMap.get(uri);
        if (favoriteMap.has(uri))
            return favoriteMap.get(uri);
        return _this;
    }
    BookmarkItem.prototype.toJSON = function () {
        return {
            title: this.title,
            uri: this.uri
        };
    };
    return BookmarkItem;
}(observable_1.Observable));
exports.BookmarkItem = BookmarkItem;
var favoriteList = new observable_array_1.ObservableArray();
exports.favoriteList = favoriteList;
var historyList = new observable_array_1.ObservableArray();
exports.historyList = historyList;
var realityList = new observable_array_1.ObservableArray();
exports.realityList = realityList;
var FilterControl = (function (_super) {
    __extends(FilterControl, _super);
    function FilterControl() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.showFilteredResults = false;
        return _this;
    }
    return FilterControl;
}(observable_1.Observable));
var filterControl = new FilterControl();
exports.filterControl = filterControl;
var filteredFavoriteList = new observable_array_1.ObservableArray();
exports.filteredFavoriteList = filteredFavoriteList;
var filteredHistoryList = new observable_array_1.ObservableArray();
exports.filteredHistoryList = filteredHistoryList;
var favoriteMap = new Map();
exports.favoriteMap = favoriteMap;
var historyMap = new Map();
exports.historyMap = historyMap;
var realityMap = new Map();
exports.realityMap = realityMap;
function updateMap(data, map) {
    var list = data.object;
    for (var i = 0; i < data.addedCount; i++) {
        var item = list.getItem(data.index + i);
        map.set(item.uri, item);
    }
    data.removed && data.removed.forEach(function (item) {
        map.delete(item.uri);
    });
}
favoriteList.on('change', function (data) { return updateMap(data, favoriteMap); });
historyList.on('change', function (data) { return updateMap(data, historyMap); });
realityList.on('change', function (data) { return updateMap(data, realityMap); });
var builtinFavorites = [
    new BookmarkItem({
        title: 'Argon Help',
        uri: 'http://app.argonjs.io/'
    }),
    new BookmarkItem({
        title: 'Argon Samples',
        uri: 'https://samples.argonjs.io/'
    }),
    new BookmarkItem({
        title: 'Argon-AFrame Samples',
        uri: 'https://aframe.argonjs.io/'
    }),
    new BookmarkItem({
        title: 'Credits',
        uri: 'http://www.argonjs.io/#support'
    })
];
builtinFavorites.forEach(function (item) {
    item.builtin = true;
    favoriteList.push(item);
});
var builtinRealities = [
    new BookmarkItem({ uri: Argon.RealityViewer.LIVE, title: 'Live' })
];
builtinRealities.forEach(function (item) {
    item.builtin = true;
    realityList.push(item);
});
var FAVORITE_LIST_KEY = 'favorite_list';
var HISTORY_LIST_KEY = 'history_list';
if (applicationSettings.hasKey(FAVORITE_LIST_KEY)) {
    console.log(applicationSettings.getString(FAVORITE_LIST_KEY));
    var savedFavorites = JSON.parse(applicationSettings.getString(FAVORITE_LIST_KEY));
    savedFavorites.forEach(function (item) {
        if (!favoriteMap.has(item.uri))
            favoriteList.push(new BookmarkItem(item));
    });
}
if (applicationSettings.hasKey(HISTORY_LIST_KEY)) {
    console.log(applicationSettings.getString(HISTORY_LIST_KEY));
    var savedHistory = JSON.parse(applicationSettings.getString(HISTORY_LIST_KEY));
    savedHistory.forEach(function (item) {
        historyList.push(new BookmarkItem(item));
    });
}
function saveFavorites() {
    var userFavorites = favoriteList.filter(function (item) { return !item.builtin; });
    applicationSettings.setString(FAVORITE_LIST_KEY, JSON.stringify(userFavorites));
}
function saveHistory() {
    var history = historyList.map(function (item) { return item; }); // convert to standard array
    applicationSettings.setString(HISTORY_LIST_KEY, JSON.stringify(history));
}
function saveBookmarks() {
    saveFavorites();
    saveHistory();
}
application.on(application.suspendEvent, saveBookmarks);
favoriteList.on('change', saveFavorites);
historyList.on('change', saveHistory);
function pushToHistory(url, title) {
    var historyBookmarkItem = historyMap.get(url);
    if (historyBookmarkItem) {
        var i = historyList.indexOf(historyBookmarkItem);
        historyList.splice(i, 1);
        historyList.unshift(historyBookmarkItem);
    }
    else {
        historyList.unshift(new BookmarkItem({
            uri: url,
            title: title
        }));
    }
}
exports.pushToHistory = pushToHistory;
function updateTitle(url, title) {
    var historyBookmarkItem = historyMap.get(url);
    if (historyBookmarkItem && !historyBookmarkItem.builtin) {
        historyBookmarkItem.set('title', title);
    }
}
exports.updateTitle = updateTitle;
function filterBookmarks(text) {
    var regex = new RegExp(text, "i");
    clearFilter();
    favoriteList.forEach(function (bookmark) {
        if (regex.test(bookmark.uri) || (bookmark.title && regex.test(bookmark.title))) {
            filteredFavoriteList.push(bookmark);
        }
    });
    historyList.forEach(function (bookmark) {
        if (regex.test(bookmark.uri) || (bookmark.title && regex.test(bookmark.title))) {
            filteredHistoryList.push(bookmark);
        }
    });
}
exports.filterBookmarks = filterBookmarks;
function clearFilter() {
    while (filteredFavoriteList.length > 0) {
        filteredFavoriteList.pop();
    }
    while (filteredHistoryList.length > 0) {
        filteredHistoryList.pop();
    }
}
exports.clearFilter = clearFilter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9va21hcmtzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYm9va21hcmtzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTRDO0FBQzVDLDBEQUE2RDtBQUM3RCwwREFBbUU7QUFDbkUsOENBQTJDO0FBRTNDLHNDQUF1QztBQUV2QztJQUEyQixnQ0FBVTtJQUtqQyxzQkFBWSxJQUdYO1FBSEQsWUFJSSxrQkFBTSxJQUFJLENBQUMsU0FPZDtRQWJELGFBQU8sR0FBRyxLQUFLLENBQUM7UUFPWixJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBQ3JCLCtDQUErQztRQUMvQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFFLENBQUM7UUFDckQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBRSxDQUFDO1FBQ3JELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUUsQ0FBQztRQUN2RCxNQUFNLENBQUMsS0FBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCw2QkFBTSxHQUFOO1FBQ0ksTUFBTSxDQUFDO1lBQ0gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRztTQUNoQixDQUFBO0lBQ0wsQ0FBQztJQUNMLG1CQUFDO0FBQUQsQ0FBQyxBQXhCRCxDQUEyQix1QkFBVSxHQXdCcEM7QUEwR0csb0NBQVk7QUF4R2hCLElBQU0sWUFBWSxHQUFHLElBQUksa0NBQWUsRUFBZ0IsQ0FBQztBQXlHckQsb0NBQVk7QUF4R2hC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QzdFLG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN4QyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDSCxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBUTtRQUN6QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0UsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFiRCwwQ0FhQztBQUVEO0lBQ0ksT0FBTyxvQkFBb0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDckMsb0JBQW9CLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUNELE9BQU8sbUJBQW1CLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3BDLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzlCLENBQUM7QUFDTCxDQUFDO0FBUEQsa0NBT0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXBwbGljYXRpb24gPSByZXF1aXJlKCdhcHBsaWNhdGlvbicpO1xuaW1wb3J0IGFwcGxpY2F0aW9uU2V0dGluZ3MgPSByZXF1aXJlKCdhcHBsaWNhdGlvbi1zZXR0aW5ncycpO1xuaW1wb3J0IHtPYnNlcnZhYmxlQXJyYXksIENoYW5nZWREYXRhfSBmcm9tICdkYXRhL29ic2VydmFibGUtYXJyYXknO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdkYXRhL29ic2VydmFibGUnO1xuXG5pbXBvcnQgKiBhcyBBcmdvbiBmcm9tICdAYXJnb25qcy9hcmdvbidcblxuY2xhc3MgQm9va21hcmtJdGVtIGV4dGVuZHMgT2JzZXJ2YWJsZSB7XG4gICAgdGl0bGU/OnN0cmluZztcbiAgICB1cmk6c3RyaW5nO1xuICAgIGJ1aWx0aW4gPSBmYWxzZTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihpdGVtOntcbiAgICAgICAgdGl0bGU/OnN0cmluZyxcbiAgICAgICAgdXJpOnN0cmluZ1xuICAgIH0pIHtcbiAgICAgICAgc3VwZXIoaXRlbSk7XG4gICAgICAgIGNvbnN0IHVyaSA9IGl0ZW0udXJpO1xuICAgICAgICAvLyByZXVzZSBhbiBleGlzdGluZyBCb29rbWFya0l0ZW0gaWYgb25lIGV4aXN0c1xuICAgICAgICBpZiAoaGlzdG9yeU1hcC5oYXModXJpKSkgcmV0dXJuIGhpc3RvcnlNYXAuZ2V0KHVyaSkhOyBcbiAgICAgICAgaWYgKHJlYWxpdHlNYXAuaGFzKHVyaSkpIHJldHVybiByZWFsaXR5TWFwLmdldCh1cmkpITsgXG4gICAgICAgIGlmIChmYXZvcml0ZU1hcC5oYXModXJpKSkgcmV0dXJuIGZhdm9yaXRlTWFwLmdldCh1cmkpITsgXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBcbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0aXRsZTogdGhpcy50aXRsZSxcbiAgICAgICAgICAgIHVyaTogdGhpcy51cmlcbiAgICAgICAgfVxuICAgIH1cbn1cblxuY29uc3QgZmF2b3JpdGVMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XG5jb25zdCBoaXN0b3J5TGlzdCA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8Qm9va21hcmtJdGVtPigpO1xuY29uc3QgcmVhbGl0eUxpc3QgPSBuZXcgT2JzZXJ2YWJsZUFycmF5PEJvb2ttYXJrSXRlbT4oKTtcblxuY2xhc3MgRmlsdGVyQ29udHJvbCBleHRlbmRzIE9ic2VydmFibGUge1xuICAgIHNob3dGaWx0ZXJlZFJlc3VsdHMgPSBmYWxzZTtcbn1cblxudmFyIGZpbHRlckNvbnRyb2wgPSBuZXcgRmlsdGVyQ29udHJvbCgpO1xudmFyIGZpbHRlcmVkRmF2b3JpdGVMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XG52YXIgZmlsdGVyZWRIaXN0b3J5TGlzdCA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8Qm9va21hcmtJdGVtPigpO1xuXG5jb25zdCBmYXZvcml0ZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBCb29rbWFya0l0ZW0+KCk7XG5jb25zdCBoaXN0b3J5TWFwID0gbmV3IE1hcDxzdHJpbmcsIEJvb2ttYXJrSXRlbT4oKTtcbmNvbnN0IHJlYWxpdHlNYXAgPSBuZXcgTWFwPHN0cmluZywgQm9va21hcmtJdGVtPigpO1xuXG5mdW5jdGlvbiB1cGRhdGVNYXAoZGF0YTpDaGFuZ2VkRGF0YTxCb29rbWFya0l0ZW0+LCBtYXA6TWFwPHN0cmluZywgQm9va21hcmtJdGVtPikge1xuICAgIGNvbnN0IGxpc3QgPSA8T2JzZXJ2YWJsZUFycmF5PEJvb2ttYXJrSXRlbT4+ZGF0YS5vYmplY3RcbiAgICBmb3IgKGxldCBpPTA7IGkgPCBkYXRhLmFkZGVkQ291bnQ7IGkrKykge1xuICAgICAgICB2YXIgaXRlbSA9IGxpc3QuZ2V0SXRlbShkYXRhLmluZGV4ICsgaSk7XG4gICAgICAgIG1hcC5zZXQoaXRlbS51cmksIGl0ZW0pO1xuICAgIH1cbiAgICBkYXRhLnJlbW92ZWQgJiYgZGF0YS5yZW1vdmVkLmZvckVhY2goKGl0ZW0pPT57XG4gICAgICAgIG1hcC5kZWxldGUoaXRlbS51cmkpO1xuICAgIH0pXG59XG5cbmZhdm9yaXRlTGlzdC5vbignY2hhbmdlJywgKGRhdGEpID0+IHVwZGF0ZU1hcChkYXRhLCBmYXZvcml0ZU1hcCkpO1xuaGlzdG9yeUxpc3Qub24oJ2NoYW5nZScsIChkYXRhKSA9PiB1cGRhdGVNYXAoZGF0YSwgaGlzdG9yeU1hcCkpO1xucmVhbGl0eUxpc3Qub24oJ2NoYW5nZScsIChkYXRhKSA9PiB1cGRhdGVNYXAoZGF0YSwgcmVhbGl0eU1hcCkpO1xuXG5jb25zdCBidWlsdGluRmF2b3JpdGVzOkFycmF5PEJvb2ttYXJrSXRlbT4gPSBbXG4gICAgbmV3IEJvb2ttYXJrSXRlbSh7XG4gICAgICAgIHRpdGxlOiAnQXJnb24gSGVscCcsXG4gICAgICAgIHVyaTogJ2h0dHA6Ly9hcHAuYXJnb25qcy5pby8nXG4gICAgfSksXG4gICAgbmV3IEJvb2ttYXJrSXRlbSh7XG4gICAgICAgIHRpdGxlOiAnQXJnb24gU2FtcGxlcycsXG4gICAgICAgIHVyaTogJ2h0dHBzOi8vc2FtcGxlcy5hcmdvbmpzLmlvLydcbiAgICB9KSxcbiAgICBuZXcgQm9va21hcmtJdGVtKHtcbiAgICAgICAgdGl0bGU6ICdBcmdvbi1BRnJhbWUgU2FtcGxlcycsXG4gICAgICAgIHVyaTogJ2h0dHBzOi8vYWZyYW1lLmFyZ29uanMuaW8vJ1xuICAgIH0pLFxuICAgIG5ldyBCb29rbWFya0l0ZW0oe1xuICAgICAgICB0aXRsZTogJ0NyZWRpdHMnLFxuICAgICAgICB1cmk6ICdodHRwOi8vd3d3LmFyZ29uanMuaW8vI3N1cHBvcnQnXG4gICAgfSlcbl1cblxuYnVpbHRpbkZhdm9yaXRlcy5mb3JFYWNoKChpdGVtKT0+IHsgXG4gICAgaXRlbS5idWlsdGluID0gdHJ1ZTtcbiAgICBmYXZvcml0ZUxpc3QucHVzaChpdGVtKTtcbn0pO1xuXG5jb25zdCBidWlsdGluUmVhbGl0aWVzOkFycmF5PEJvb2ttYXJrSXRlbT4gPSBbXG4gICAgbmV3IEJvb2ttYXJrSXRlbSh7dXJpOkFyZ29uLlJlYWxpdHlWaWV3ZXIuTElWRSwgdGl0bGU6J0xpdmUnfSlcbl1cblxuYnVpbHRpblJlYWxpdGllcy5mb3JFYWNoKChpdGVtKT0+IHsgXG4gICAgaXRlbS5idWlsdGluID0gdHJ1ZTtcbiAgICByZWFsaXR5TGlzdC5wdXNoKGl0ZW0pO1xufSk7XG5cbmNvbnN0IEZBVk9SSVRFX0xJU1RfS0VZID0gJ2Zhdm9yaXRlX2xpc3QnO1xuY29uc3QgSElTVE9SWV9MSVNUX0tFWSA9ICdoaXN0b3J5X2xpc3QnO1xuXG5pZiAoYXBwbGljYXRpb25TZXR0aW5ncy5oYXNLZXkoRkFWT1JJVEVfTElTVF9LRVkpKSB7XG4gICAgY29uc29sZS5sb2coYXBwbGljYXRpb25TZXR0aW5ncy5nZXRTdHJpbmcoRkFWT1JJVEVfTElTVF9LRVkpKVxuICAgIGNvbnN0IHNhdmVkRmF2b3JpdGVzOkFycmF5PEJvb2ttYXJrSXRlbT4gPSBKU09OLnBhcnNlKGFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKEZBVk9SSVRFX0xJU1RfS0VZKSk7XG4gICAgc2F2ZWRGYXZvcml0ZXMuZm9yRWFjaCgoaXRlbSk9PntcbiAgICAgICAgaWYgKCFmYXZvcml0ZU1hcC5oYXMoaXRlbS51cmkpKVxuICAgICAgICAgICAgZmF2b3JpdGVMaXN0LnB1c2gobmV3IEJvb2ttYXJrSXRlbShpdGVtKSk7XG4gICAgfSk7XG59XG5cbmlmIChhcHBsaWNhdGlvblNldHRpbmdzLmhhc0tleShISVNUT1JZX0xJU1RfS0VZKSkge1xuICAgIGNvbnNvbGUubG9nKGFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKEhJU1RPUllfTElTVF9LRVkpKVxuICAgIGNvbnN0IHNhdmVkSGlzdG9yeTpBcnJheTxCb29rbWFya0l0ZW0+ID0gSlNPTi5wYXJzZShhcHBsaWNhdGlvblNldHRpbmdzLmdldFN0cmluZyhISVNUT1JZX0xJU1RfS0VZKSk7XG4gICAgc2F2ZWRIaXN0b3J5LmZvckVhY2goKGl0ZW0pPT57XG4gICAgICAgIGhpc3RvcnlMaXN0LnB1c2gobmV3IEJvb2ttYXJrSXRlbShpdGVtKSk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHNhdmVGYXZvcml0ZXMoKSB7XG4gICAgY29uc3QgdXNlckZhdm9yaXRlcyA9IGZhdm9yaXRlTGlzdC5maWx0ZXIoKGl0ZW0pPT4haXRlbS5idWlsdGluKTtcbiAgICBhcHBsaWNhdGlvblNldHRpbmdzLnNldFN0cmluZyhGQVZPUklURV9MSVNUX0tFWSwgSlNPTi5zdHJpbmdpZnkodXNlckZhdm9yaXRlcykpO1xufVxuXG5mdW5jdGlvbiBzYXZlSGlzdG9yeSgpIHtcbiAgICBjb25zdCBoaXN0b3J5ID0gaGlzdG9yeUxpc3QubWFwKChpdGVtKT0+aXRlbSk7IC8vIGNvbnZlcnQgdG8gc3RhbmRhcmQgYXJyYXlcbiAgICBhcHBsaWNhdGlvblNldHRpbmdzLnNldFN0cmluZyhISVNUT1JZX0xJU1RfS0VZLCBKU09OLnN0cmluZ2lmeShoaXN0b3J5KSk7XG59XG5cbmZ1bmN0aW9uIHNhdmVCb29rbWFya3MoKSB7XG4gICAgc2F2ZUZhdm9yaXRlcygpO1xuICAgIHNhdmVIaXN0b3J5KCk7XG59XG5cbmFwcGxpY2F0aW9uLm9uKGFwcGxpY2F0aW9uLnN1c3BlbmRFdmVudCxzYXZlQm9va21hcmtzKTtcbmZhdm9yaXRlTGlzdC5vbignY2hhbmdlJywgc2F2ZUZhdm9yaXRlcyk7XG5oaXN0b3J5TGlzdC5vbignY2hhbmdlJywgc2F2ZUhpc3RvcnkpO1xuXG5leHBvcnQge1xuICAgIEJvb2ttYXJrSXRlbSxcbiAgICBmYXZvcml0ZUxpc3QsXG4gICAgaGlzdG9yeUxpc3QsXG4gICAgcmVhbGl0eUxpc3QsXG4gICAgZmF2b3JpdGVNYXAsXG4gICAgaGlzdG9yeU1hcCxcbiAgICByZWFsaXR5TWFwLFxuICAgIGZpbHRlckNvbnRyb2wsXG4gICAgZmlsdGVyZWRGYXZvcml0ZUxpc3QsXG4gICAgZmlsdGVyZWRIaXN0b3J5TGlzdFxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHVzaFRvSGlzdG9yeSh1cmw6c3RyaW5nLCB0aXRsZT86c3RyaW5nKSB7XG4gICAgY29uc3QgaGlzdG9yeUJvb2ttYXJrSXRlbSA9IGhpc3RvcnlNYXAuZ2V0KHVybCk7XG4gICAgaWYgKGhpc3RvcnlCb29rbWFya0l0ZW0pIHtcbiAgICAgICAgbGV0IGkgPSBoaXN0b3J5TGlzdC5pbmRleE9mKGhpc3RvcnlCb29rbWFya0l0ZW0pO1xuICAgICAgICBoaXN0b3J5TGlzdC5zcGxpY2UoaSwgMSk7XG4gICAgICAgIGhpc3RvcnlMaXN0LnVuc2hpZnQoaGlzdG9yeUJvb2ttYXJrSXRlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaGlzdG9yeUxpc3QudW5zaGlmdChuZXcgQm9va21hcmtJdGVtKHtcbiAgICAgICAgICAgIHVyaTogdXJsLFxuICAgICAgICAgICAgdGl0bGU6IHRpdGxlXG4gICAgICAgIH0pKVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVRpdGxlKHVybDpzdHJpbmcsIHRpdGxlOnN0cmluZykge1xuICAgIHZhciBoaXN0b3J5Qm9va21hcmtJdGVtID0gaGlzdG9yeU1hcC5nZXQodXJsKTtcbiAgICBpZiAoaGlzdG9yeUJvb2ttYXJrSXRlbSAmJiAhaGlzdG9yeUJvb2ttYXJrSXRlbS5idWlsdGluKSB7XG4gICAgICAgIGhpc3RvcnlCb29rbWFya0l0ZW0uc2V0KCd0aXRsZScsIHRpdGxlKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJCb29rbWFya3ModGV4dDpzdHJpbmcpIHtcbiAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAodGV4dCwgXCJpXCIpO1xuICAgIGNsZWFyRmlsdGVyKCk7XG4gICAgZmF2b3JpdGVMaXN0LmZvckVhY2goKGJvb2ttYXJrKT0+IHtcbiAgICAgICAgaWYgKHJlZ2V4LnRlc3QoYm9va21hcmsudXJpKSB8fCAoYm9va21hcmsudGl0bGUgJiYgcmVnZXgudGVzdChib29rbWFyay50aXRsZSkpKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZEZhdm9yaXRlTGlzdC5wdXNoKGJvb2ttYXJrKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGhpc3RvcnlMaXN0LmZvckVhY2goKGJvb2ttYXJrKT0+IHtcbiAgICAgICAgaWYgKHJlZ2V4LnRlc3QoYm9va21hcmsudXJpKSB8fCAoYm9va21hcmsudGl0bGUgJiYgcmVnZXgudGVzdChib29rbWFyay50aXRsZSkpKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZEhpc3RvcnlMaXN0LnB1c2goYm9va21hcmspO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhckZpbHRlcigpIHtcbiAgICB3aGlsZSAoZmlsdGVyZWRGYXZvcml0ZUxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICBmaWx0ZXJlZEZhdm9yaXRlTGlzdC5wb3AoKTtcbiAgICB9XG4gICAgd2hpbGUgKGZpbHRlcmVkSGlzdG9yeUxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICBmaWx0ZXJlZEhpc3RvcnlMaXN0LnBvcCgpO1xuICAgIH1cbn0iXX0=
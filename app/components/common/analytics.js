"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var googleAnalytics = require("nativescript-google-analytics");
var application = require("application");
var AppViewModel_1 = require("./AppViewModel");
var isFirstLoad = true;
var pageLoadTimerId = -1;
var maxActiveApps = 0;
var maxInstalledRealities = 0;
var currentRealityUri = "";
var focusTimerActive = false;
var appFocusTimerID = "App Focus";
function initAnalytics() {
    googleAnalytics.initalize({
        trackingId: "UA-98725997-1",
        dispatchInterval: 10,
        logging: {
            native: true,
            console: true
        }
    });
}
exports.initAnalytics = initAnalytics;
function updateArgonAppCount(count) {
    if (count > maxActiveApps) {
        maxActiveApps = count;
        if (count > 1) {
            logActiveAppCount(count);
        }
    }
}
exports.updateArgonAppCount = updateArgonAppCount;
function updateInstalledRealityCount(count) {
    if (count > maxInstalledRealities) {
        maxInstalledRealities = count;
        if (count > 1) {
            logInstalledRealityCount(count);
        }
    }
}
exports.updateInstalledRealityCount = updateInstalledRealityCount;
function updateCurrentRealityUri(uri) {
    currentRealityUri = uri;
}
exports.updateCurrentRealityUri = updateCurrentRealityUri;
function realityManuallyChanged(uri) {
    if (uri != currentRealityUri) {
        logRealityManuallyChanged();
    }
}
exports.realityManuallyChanged = realityManuallyChanged;
AppViewModel_1.appViewModel.ready.then(function () {
    if (isFirstLoad) {
        logAppStart();
        AppViewModel_1.appViewModel.argon.provider.focus.sessionFocusEvent.addEventListener(function (_a) {
            var current = _a.current;
            if (current && current.uri != "argon:manager") {
                logAppFocus(current.uri);
                current.closeEvent.addEventListener(function () { clearAppFocus(); });
            }
            else {
                clearAppFocus();
            }
        });
    }
});
AppViewModel_1.appViewModel.on('propertyChange', function (evt) {
    if (evt.propertyName === 'currentUri') {
        // User needs to stay on a page for a few seconds for it to count as a page load
        // This way redirects and accidental clicks aren't logged
        clearTimeout(pageLoadTimerId);
        if (AppViewModel_1.appViewModel.currentUri) {
            pageLoadTimerId = setTimeout(function () {
                logPageLoad(AppViewModel_1.appViewModel.currentUri);
            }, 3000);
        }
    }
});
application.on(application.resumeEvent, function () {
    if (!isFirstLoad) {
        logAppResume();
    }
});
application.on(application.suspendEvent, function () {
    isFirstLoad = false;
    clearAppFocus();
});
function logAppStart() {
    googleAnalytics.logEvent({
        category: "App Start",
        action: AppViewModel_1.appViewModel.launchedFromUrl ? "URL Launch" : "User Launch",
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
function logAppResume() {
    googleAnalytics.logEvent({
        category: "App Resume",
        action: AppViewModel_1.appViewModel.launchedFromUrl ? "URL Launch" : "User Launch",
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
function logPageLoad(url) {
    var type = "Page Loaded (other)";
    if (url.includes("argonjs.io")) {
        type = "Page Loaded (argonjs.io)";
    }
    else if (url.includes("google.com/search")) {
        type = "Google Search";
    }
    googleAnalytics.logEvent({
        category: "Page Load",
        action: type,
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
function logAppFocus(url) {
    var type = "App Focus (other)";
    if (url.includes("argonjs.io")) {
        type = "App Focus (argonjs.io)";
    }
    if (focusTimerActive)
        googleAnalytics.stopTimer(appFocusTimerID);
    googleAnalytics.startTimer(appFocusTimerID, {
        category: "App Focus",
        name: type,
        label: (application.ios) ? "iOS" : "Android"
    });
    focusTimerActive = true;
}
function clearAppFocus() {
    if (focusTimerActive)
        googleAnalytics.stopTimer(appFocusTimerID);
    focusTimerActive = false;
}
function logActiveAppCount(count) {
    googleAnalytics.logEvent({
        category: "Multiple Apps",
        action: (count + " Apps Open"),
        label: application.ios ? "iOS" : "Android",
        value: count
    });
}
function logInstalledRealityCount(count) {
    googleAnalytics.logEvent({
        category: "Multiple Realities",
        action: (count + " Realities Installed"),
        label: application.ios ? "iOS" : "Android",
        value: count
    });
}
function logRealityManuallyChanged() {
    googleAnalytics.logEvent({
        category: "Reality Change",
        action: "Manual Reality Change",
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5hbHl0aWNzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYW5hbHl0aWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0RBQWlFO0FBQ2pFLHlDQUEyQztBQUUzQywrQ0FBNEM7QUFFNUMsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLElBQUksZUFBZSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztBQUN0QixJQUFJLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUM5QixJQUFJLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztBQUMzQixJQUFJLGdCQUFnQixHQUFHLEtBQUssQ0FBQztBQUU3QixJQUFNLGVBQWUsR0FBRyxXQUFXLENBQUM7QUFFcEM7SUFDSSxlQUFlLENBQUMsU0FBUyxDQUFDO1FBQ3RCLFVBQVUsRUFBRSxlQUFlO1FBQzNCLGdCQUFnQixFQUFFLEVBQUU7UUFDcEIsT0FBTyxFQUFPO1lBQ1YsTUFBTSxFQUFFLElBQUk7WUFDWixPQUFPLEVBQUUsSUFBSTtTQUNoQjtLQUNKLENBQUMsQ0FBQztBQUNQLENBQUM7QUFURCxzQ0FTQztBQUVELDZCQUFvQyxLQUFZO0lBQzVDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFDdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDWixpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDO0lBQ0wsQ0FBQztBQUNMLENBQUM7QUFQRCxrREFPQztBQUVELHFDQUE0QyxLQUFZO0lBQ3BELEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7UUFDaEMscUJBQXFCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMs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ZSxDQUFDLENBQUM7SUFDakUsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0FBQzdCLENBQUM7QUFFRCwyQkFBMkIsS0FBYTtJQUNwQyxlQUFlLENBQUMsUUFBUSxDQUFDO1FBQ3JCLFFBQVEsRUFBRSxlQUFlO1FBQ3pCLE1BQU0sRUFBRSxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUM7UUFDOUIsS0FBSyxFQUFFLFdBQVcsQ0FBQyxHQUFHLEdBQUcsS0FBSyxHQUFHLFNBQVM7UUFDMUMsS0FBSyxFQUFFLEtBQUs7S0FDZixDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsa0NBQWtDLEtBQWE7SUFDM0MsZUFBZSxDQUFDLFFBQVEsQ0FBQztRQUNyQixRQUFRLEVBQUUsb0JBQW9CO1FBQzlCLE1BQU0sRUFBRSxDQUFDLEtBQUssR0FBRyxzQkFBc0IsQ0FBQztRQUN4QyxLQUFLLEVBQUUsV0FBVyxDQUFDLEdBQUcsR0FBRyxLQUFLLEdBQUcsU0FBUztRQUMxQyxLQUFLLEVBQUUsS0FBSztLQUNmLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRDtJQUNJLGVBQWUsQ0FBQyxRQUFRLENBQUM7UUFDckIsUUFBUSxFQUFFLGdCQUFnQjtRQUMxQixNQUFNLEVBQUUsdUJBQXVCO1FBQy9CLEtBQUssRUFBRSxXQUFXLENBQUMsR0FBRyxHQUFHLEtBQUssR0FBRyxTQUFTO1FBQzFDLEtBQUssRUFBRSxDQUFDO0tBQ1gsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdvb2dsZUFuYWx5dGljcyBmcm9tIFwibmF0aXZlc2NyaXB0LWdvb2dsZS1hbmFseXRpY3NcIjtcbmltcG9ydCAqIGFzIGFwcGxpY2F0aW9uIGZyb20gJ2FwcGxpY2F0aW9uJztcbmltcG9ydCB7UHJvcGVydHlDaGFuZ2VEYXRhfSBmcm9tICdkYXRhL29ic2VydmFibGUnXG5pbXBvcnQge2FwcFZpZXdNb2RlbH0gZnJvbSAnLi9BcHBWaWV3TW9kZWwnO1xuXG52YXIgaXNGaXJzdExvYWQgPSB0cnVlO1xudmFyIHBhZ2VMb2FkVGltZXJJZCA9IC0xO1xudmFyIG1heEFjdGl2ZUFwcHMgPSAwO1xudmFyIG1heEluc3RhbGxlZFJlYWxpdGllcyA9IDA7XG52YXIgY3VycmVudFJlYWxpdHlVcmkgPSBcIlwiO1xudmFyIGZvY3VzVGltZXJBY3RpdmUgPSBmYWxzZTtcblxuY29uc3QgYXBwRm9jdXNUaW1lcklEID0gXCJBcHAgRm9jdXNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXRBbmFseXRpY3MoKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmluaXRhbGl6ZSh7XG4gICAgICAgIHRyYWNraW5nSWQ6IFwiVUEtOTg3MjU5OTctMVwiLFxuICAgICAgICBkaXNwYXRjaEludGVydmFsOiAxMCxcbiAgICAgICAgbG9nZ2luZzogPGFueT57XG4gICAgICAgICAgICBuYXRpdmU6IHRydWUsXG4gICAgICAgICAgICBjb25zb2xlOiB0cnVlXG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUFyZ29uQXBwQ291bnQoY291bnQ6bnVtYmVyKSB7XG4gICAgaWYgKGNvdW50ID4gbWF4QWN0aXZlQXBwcykge1xuICAgICAgICBtYXhBY3RpdmVBcHBzID0gY291bnQ7XG4gICAgICAgIGlmIChjb3VudCA+IDEpIHtcbiAgICAgICAgICAgIGxvZ0FjdGl2ZUFwcENvdW50KGNvdW50KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUluc3RhbGxlZFJlYWxpdHlDb3VudChjb3VudDpudW1iZXIpIHtcbiAgICBpZiAoY291bnQgPiBtYXhJbnN0YWxsZWRSZWFsaXRpZXMpIHtcbiAgICAgICAgbWF4SW5zdGFsbGVkUmVhbGl0aWVzID0gY291bnQ7XG4gICAgICAgIGlmIChjb3VudCA+IDEpIHtcbiAgICAgICAgICAgIGxvZ0luc3RhbGxlZFJlYWxpdHlDb3VudChjb3VudCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVDdXJyZW50UmVhbGl0eVVyaSh1cmk6c3RyaW5nKSB7XG4gICAgY3VycmVudFJlYWxpdHlVcmkgPSB1cmk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFsaXR5TWFudWFsbHlDaGFuZ2VkKHVyaTpzdHJpbmcpIHtcbiAgICBpZiAodXJpICE9IGN1cnJlbnRSZWFsaXR5VXJpKSB7XG4gICAgICAgIGxvZ1JlYWxpdHlNYW51YWxseUNoYW5nZWQoKTtcbiAgICB9XG59XG5cbmFwcFZpZXdNb2RlbC5yZWFkeS50aGVuKCgpPT57XG4gICAgaWYgKGlzRmlyc3RMb2FkKSB7XG4gICAgICAgIGxvZ0FwcFN0YXJ0KCk7XG5cbiAgICAgICAgYXBwVmlld01vZGVsLmFyZ29uLnByb3ZpZGVyLmZvY3VzLnNlc3Npb25Gb2N1c0V2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKHtjdXJyZW50fSk9PntcbiAgICAgICAgICAgIGlmIChjdXJyZW50ICYmIGN1cnJlbnQudXJpICE9IFwiYXJnb246bWFuYWdlclwiKSB7XG4gICAgICAgICAgICAgICAgbG9nQXBwRm9jdXMoY3VycmVudC51cmkpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnQuY2xvc2VFdmVudC5hZGRFdmVudExpc3RlbmVyKCgpID0+IHsgY2xlYXJBcHBGb2N1cygpOyB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2xlYXJBcHBGb2N1cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59KTtcblxuYXBwVmlld01vZGVsLm9uKCdwcm9wZXJ0eUNoYW5nZScsIChldnQ6UHJvcGVydHlDaGFuZ2VEYXRhKT0+e1xuICAgIGlmIChldnQucHJvcGVydHlOYW1lID09PSAnY3VycmVudFVyaScpIHtcbiAgICAgICAgLy8gVXNlciBuZWVkcyB0byBzdGF5IG9uIGEgcGFnZSBmb3IgYSBmZXcgc2Vjb25kcyBmb3IgaXQgdG8gY291bnQgYXMgYSBwYWdlIGxvYWRcbiAgICAgICAgLy8gVGhpcyB3YXkgcmVkaXJlY3RzIGFuZCBhY2NpZGVudGFsIGNsaWNrcyBhcmVuJ3QgbG9nZ2VkXG4gICAgICAgIGNsZWFyVGltZW91dChwYWdlTG9hZFRpbWVySWQpO1xuICAgICAgICBpZiAoYXBwVmlld01vZGVsLmN1cnJlbnRVcmkpIHtcbiAgICAgICAgICAgIHBhZ2VMb2FkVGltZXJJZCA9IHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICAgICAgICBsb2dQYWdlTG9hZChhcHBWaWV3TW9kZWwuY3VycmVudFVyaSk7XG4gICAgICAgICAgICB9LCAzMDAwKTtcbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG5hcHBsaWNhdGlvbi5vbihhcHBsaWNhdGlvbi5yZXN1bWVFdmVudCwgKCk9PiB7XG4gICAgaWYgKCFpc0ZpcnN0TG9hZCkge1xuICAgICAgICBsb2dBcHBSZXN1bWUoKTtcbiAgICB9XG59KTtcblxuYXBwbGljYXRpb24ub24oYXBwbGljYXRpb24uc3VzcGVuZEV2ZW50LCAoKT0+IHtcbiAgICBpc0ZpcnN0TG9hZCA9IGZhbHNlO1xuICAgIGNsZWFyQXBwRm9jdXMoKTtcbn0pO1xuXG5cbmZ1bmN0aW9uIGxvZ0FwcFN0YXJ0KCkge1xuICAgIGdvb2dsZUFuYWx5dGljcy5sb2dFdmVudCh7XG4gICAgICAgIGNhdGVnb3J5OiBcIkFwcCBTdGFydFwiLFxuICAgICAgICBhY3Rpb246IGFwcFZpZXdNb2RlbC5sYXVuY2hlZEZyb21VcmwgPyBcIlVSTCBMYXVuY2hcIiA6IFwiVXNlciBMYXVuY2hcIixcbiAgICAgICAgbGFiZWw6IGFwcGxpY2F0aW9uLmlvcyA/IFwiaU9TXCIgOiBcIkFuZHJvaWRcIixcbiAgICAgICAgdmFsdWU6IDFcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9nQXBwUmVzdW1lKCkge1xuICAgIGdvb2dsZUFuYWx5dGljcy5sb2dFdmVudCh7XG4gICAgICAgIGNhdGVnb3J5OiBcIkFwcCBSZXN1bWVcIixcbiAgICAgICAgYWN0aW9uOiBhcHBWaWV3TW9kZWwubGF1bmNoZWRGcm9tVXJsID8gXCJVUkwgTGF1bmNoXCIgOiBcIlVzZXIgTGF1bmNoXCIsXG4gICAgICAgIGxhYmVsOiBhcHBsaWNhdGlvbi5pb3MgPyBcImlPU1wiIDogXCJBbmRyb2lkXCIsXG4gICAgICAgIHZhbHVlOiAxXG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvZ1BhZ2VMb2FkKHVybDogc3RyaW5nKSB7XG4gICAgdmFyIHR5cGUgPSBcIlBhZ2UgTG9hZGVkIChvdGhlcilcIjtcbiAgICBpZiAodXJsLmluY2x1ZGVzKFwiYXJnb25qcy5pb1wiKSkge1xuICAgICAgICB0eXBlID0gXCJQYWdlIExvYWRlZCAoYXJnb25qcy5pbylcIjtcbiAgICB9IGVsc2UgaWYgKHVybC5pbmNsdWRlcyhcImdvb2dsZS5jb20vc2VhcmNoXCIpKSB7XG4gICAgICAgIHR5cGUgPSBcIkdvb2dsZSBTZWFyY2hcIjtcbiAgICB9XG4gICAgXG4gICAgZ29vZ2xlQW5hbHl0aWNzLmxvZ0V2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiUGFnZSBMb2FkXCIsXG4gICAgICAgIGFjdGlvbjogdHlwZSxcbiAgICAgICAgbGFiZWw6IGFwcGxpY2F0aW9uLmlvcyA/IFwiaU9TXCIgOiBcIkFuZHJvaWRcIixcbiAgICAgICAgdmFsdWU6IDFcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9nQXBwRm9jdXModXJsOiBzdHJpbmcpIHtcbiAgICB2YXIgdHlwZSA9IFwiQXBwIEZvY3VzIChvdGhlcilcIjtcbiAgICBpZiAodXJsLmluY2x1ZGVzKFwiYXJnb25qcy5pb1wiKSkge1xuICAgICAgICB0eXBlID0gXCJBcHAgRm9jdXMgKGFyZ29uanMuaW8pXCI7XG4gICAgfVxuXG4gICAgaWYgKGZvY3VzVGltZXJBY3RpdmUpIGdvb2dsZUFuYWx5dGljcy5zdG9wVGltZXIoYXBwRm9jdXNUaW1lcklEKTtcbiAgICBnb29nbGVBbmFseXRpY3Muc3RhcnRUaW1lcihhcHBGb2N1c1RpbWVySUQsIHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiQXBwIEZvY3VzXCIsXG4gICAgICAgIG5hbWU6IHR5cGUsXG4gICAgICAgIGxhYmVsOiAoYXBwbGljYXRpb24uaW9zKSA/IFwiaU9TXCIgOiBcIkFuZHJvaWRcIlxuICAgIH0pO1xuICAgIGZvY3VzVGltZXJBY3RpdmUgPSB0cnVlO1xufVxuXG5mdW5jdGlvbiBjbGVhckFwcEZvY3VzKCkge1xuICAgIGlmIChmb2N1c1RpbWVyQWN0aXZlKSBnb29nbGVBbmFseXRpY3Muc3RvcFRpbWVyKGFwcEZvY3VzVGltZXJJRCk7XG4gICAgZm9jdXNUaW1lckFjdGl2ZSA9IGZhbHNlO1xufVxuXG5mdW5jdGlvbiBsb2dBY3RpdmVBcHBDb3VudChjb3VudDogbnVtYmVyKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmxvZ0V2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiTXVsdGlwbGUgQXBwc1wiLFxuICAgICAgICBhY3Rpb246IChjb3VudCArIFwiIEFwcHMgT3BlblwiKSxcbiAgICAgICAgbGFiZWw6IGFwcGxpY2F0aW9uLmlvcyA/IFwiaU9TXCIgOiBcIkFuZHJvaWRcIixcbiAgICAgICAgdmFsdWU6IGNvdW50XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvZ0luc3RhbGxlZFJlYWxpdHlDb3VudChjb3VudDogbnVtYmVyKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmxvZ0V2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiTXVsdGlwbGUgUmVhbGl0aWVzXCIsXG4gICAgICAgIGFjdGlvbjogKGNvdW50ICsgXCIgUmVhbGl0aWVzIEluc3RhbGxlZFwiKSxcbiAgICAgICAgbGFiZWw6IGFwcGxpY2F0aW9uLmlvcyA/IFwiaU9TXCIgOiBcIkFuZHJvaWRcIixcbiAgICAgICAgdmFsdWU6IGNvdW50XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvZ1JlYWxpdHlNYW51YWxseUNoYW5nZWQoKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmxvZ0V2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiUmVhbGl0eSBDaGFuZ2VcIixcbiAgICAgICAgYWN0aW9uOiBcIk1hbnVhbCBSZWFsaXR5IENoYW5nZVwiLFxuICAgICAgICBsYWJlbDogYXBwbGljYXRpb24uaW9zID8gXCJpT1NcIiA6IFwiQW5kcm9pZFwiLFxuICAgICAgICB2YWx1ZTogMVxuICAgIH0pO1xufSJdfQ==
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var googleAnalytics = require("nativescript-google-analytics");
var application = require("application");
var AppViewModel_1 = require("./AppViewModel");
var isFirstLoad = true;
var pageLoadTimerId = -1;
var maxActiveApps = 0;
var maxInstalledRealities = 0;
var currentRealityUri = "";
var focusTimerActive = false;
var appFocusTimerID = "App Focus";
function initAnalytics() {
    googleAnalytics.initalize({
        trackingId: "UA-63191442-3",
        dispatchInterval: 10,
        logging: {
            native: false,
            console: false
        }
    });
}
exports.initAnalytics = initAnalytics;
function updateArgonAppCount(count) {
    if (count > maxActiveApps) {
        maxActiveApps = count;
        if (count > 1) {
            logActiveAppCount(count);
        }
    }
}
exports.updateArgonAppCount = updateArgonAppCount;
function updateInstalledRealityCount(count) {
    if (count > maxInstalledRealities) {
        maxInstalledRealities = count;
        if (count > 1) {
            logInstalledRealityCount(count);
        }
    }
}
exports.updateInstalledRealityCount = updateInstalledRealityCount;
function updateCurrentRealityUri(uri) {
    currentRealityUri = uri;
}
exports.updateCurrentRealityUri = updateCurrentRealityUri;
function realityManuallyChanged(uri) {
    if (uri != currentRealityUri) {
        logRealityManuallyChanged();
    }
}
exports.realityManuallyChanged = realityManuallyChanged;
AppViewModel_1.appViewModel.ready.then(function () {
    if (isFirstLoad) {
        logAppStart();
        AppViewModel_1.appViewModel.argon.provider.focus.sessionFocusEvent.addEventListener(function (_a) {
            var current = _a.current;
            if (current && current.uri != "argon:manager") {
                logAppFocus(current.uri);
                current.closeEvent.addEventListener(function () { clearAppFocus(); });
            }
            else {
                clearAppFocus();
            }
        });
    }
});
AppViewModel_1.appViewModel.on('propertyChange', function (evt) {
    if (evt.propertyName === 'currentUri') {
        // User needs to stay on a page for a few seconds for it to count as a page load
        // This way redirects and accidental clicks aren't logged
        clearTimeout(pageLoadTimerId);
        if (AppViewModel_1.appViewModel.currentUri) {
            pageLoadTimerId = setTimeout(function () {
                logPageLoad(AppViewModel_1.appViewModel.currentUri);
            }, 3000);
        }
    }
});
application.on(application.resumeEvent, function () {
    if (!isFirstLoad) {
        logAppResume();
    }
});
application.on(application.suspendEvent, function () {
    isFirstLoad = false;
    clearAppFocus();
});
function logAppStart() {
    googleAnalytics.logEvent({
        category: "App Start",
        action: AppViewModel_1.appViewModel.launchedFromUrl ? "URL Launch" : "User Launch",
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
function logAppResume() {
    googleAnalytics.logEvent({
        category: "App Resume",
        action: AppViewModel_1.appViewModel.launchedFromUrl ? "URL Launch" : "User Launch",
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
function logPageLoad(url) {
    var type = "Page Loaded (other)";
    if (url.includes("argonjs.io")) {
        type = "Page Loaded (argonjs.io)";
    }
    else if (url.includes("google.com/search")) {
        type = "Google Search";
    }
    googleAnalytics.logEvent({
        category: "Page Load",
        action: type,
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
function logAppFocus(url) {
    var type = "App Focus (other)";
    if (url.includes("argonjs.io")) {
        type = "App Focus (argonjs.io)";
    }
    if (focusTimerActive)
        googleAnalytics.stopTimer(appFocusTimerID);
    googleAnalytics.startTimer(appFocusTimerID, {
        category: "App Focus",
        name: type,
        label: (application.ios) ? "iOS" : "Android"
    });
    focusTimerActive = true;
}
function clearAppFocus() {
    if (focusTimerActive)
        googleAnalytics.stopTimer(appFocusTimerID);
    focusTimerActive = false;
}
function logActiveAppCount(count) {
    googleAnalytics.logEvent({
        category: "Multiple Apps",
        action: (count + " Apps Open"),
        label: application.ios ? "iOS" : "Android",
        value: count
    });
}
function logInstalledRealityCount(count) {
    googleAnalytics.logEvent({
        category: "Multiple Realities",
        action: (count + " Realities Installed"),
        label: application.ios ? "iOS" : "Android",
        value: count
    });
}
function logRealityManuallyChanged() {
    googleAnalytics.logEvent({
        category: "Reality Change",
        action: "Manual Reality Change",
        label: application.ios ? "iOS" : "Android",
        value: 1
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5hbHl0aWNzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYW5hbHl0aWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0RBQWlFO0FBQ2pFLHlDQUEyQztBQUUzQywrQ0FBNEM7QUFFNUMsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLElBQUksZUFBZSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3pCLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztBQUN0QixJQUFJLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUM5QixJQUFJLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztBQUMzQixJQUFJLGdCQUFnQixHQUFHLEtBQUssQ0FBQztBQUU3QixJQUFNLGVBQWUsR0FBRyxXQUFXLENBQUM7QUFFcEM7SUFDSSxlQUFlLENBQUMsU0FBUyxDQUFDO1FBQ3RCLFVBQVUsRUFBRSxlQUFlO1FBQzNCLGdCQUFnQixFQUFFLEVBQUU7UUFDcEIsT0FBTyxFQUFPO1lBQ1YsTUFBTSxFQUFFLEtBQUs7WUFDYixPQUFPLEVBQUUsS0FBSztTQUNqQjtLQUNKLENBQUMsQ0FBQztBQUNQLENBQUM7QUFURCxzQ0FTQztBQUVELDZCQUFvQyxLQUFZO0lBQzVDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFDdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDWixpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDO0lBQ0wsQ0FBQztBQUNMLENBQUM7QUFQRCxrREFPQztBQUVELHFDQUE0QyxLQUFZO0lBQ3BELEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7UUFDaEMscUJBQXFCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMs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ZSxDQUFDLENBQUM7SUFDakUsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0FBQzdCLENBQUM7QUFFRCwyQkFBMkIsS0FBYTtJQUNwQyxlQUFlLENBQUMsUUFBUSxDQUFDO1FBQ3JCLFFBQVEsRUFBRSxlQUFlO1FBQ3pCLE1BQU0sRUFBRSxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUM7UUFDOUIsS0FBSyxFQUFFLFdBQVcsQ0FBQyxHQUFHLEdBQUcsS0FBSyxHQUFHLFNBQVM7UUFDMUMsS0FBSyxFQUFFLEtBQUs7S0FDZixDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsa0NBQWtDLEtBQWE7SUFDM0MsZUFBZSxDQUFDLFFBQVEsQ0FBQztRQUNyQixRQUFRLEVBQUUsb0JBQW9CO1FBQzlCLE1BQU0sRUFBRSxDQUFDLEtBQUssR0FBRyxzQkFBc0IsQ0FBQztRQUN4QyxLQUFLLEVBQUUsV0FBVyxDQUFDLEdBQUcsR0FBRyxLQUFLLEdBQUcsU0FBUztRQUMxQyxLQUFLLEVBQUUsS0FBSztLQUNmLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRDtJQUNJLGVBQWUsQ0FBQyxRQUFRLENBQUM7UUFDckIsUUFBUSxFQUFFLGdCQUFnQjtRQUMxQixNQUFNLEVBQUUsdUJBQXVCO1FBQy9CLEtBQUssRUFBRSxXQUFXLENBQUMsR0FBRyxHQUFHLEtBQUssR0FBRyxTQUFTO1FBQzFDLEtBQUssRUFBRSxDQUFDO0tBQ1gsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdvb2dsZUFuYWx5dGljcyBmcm9tIFwibmF0aXZlc2NyaXB0LWdvb2dsZS1hbmFseXRpY3NcIjtcbmltcG9ydCAqIGFzIGFwcGxpY2F0aW9uIGZyb20gJ2FwcGxpY2F0aW9uJztcbmltcG9ydCB7UHJvcGVydHlDaGFuZ2VEYXRhfSBmcm9tICdkYXRhL29ic2VydmFibGUnXG5pbXBvcnQge2FwcFZpZXdNb2RlbH0gZnJvbSAnLi9BcHBWaWV3TW9kZWwnO1xuXG52YXIgaXNGaXJzdExvYWQgPSB0cnVlO1xudmFyIHBhZ2VMb2FkVGltZXJJZCA9IC0xO1xudmFyIG1heEFjdGl2ZUFwcHMgPSAwO1xudmFyIG1heEluc3RhbGxlZFJlYWxpdGllcyA9IDA7XG52YXIgY3VycmVudFJlYWxpdHlVcmkgPSBcIlwiO1xudmFyIGZvY3VzVGltZXJBY3RpdmUgPSBmYWxzZTtcblxuY29uc3QgYXBwRm9jdXNUaW1lcklEID0gXCJBcHAgRm9jdXNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGluaXRBbmFseXRpY3MoKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmluaXRhbGl6ZSh7XG4gICAgICAgIHRyYWNraW5nSWQ6IFwiVUEtNjMxOTE0NDItM1wiLFxuICAgICAgICBkaXNwYXRjaEludGVydmFsOiAxMCxcbiAgICAgICAgbG9nZ2luZzogPGFueT57XG4gICAgICAgICAgICBuYXRpdmU6IGZhbHNlLFxuICAgICAgICAgICAgY29uc29sZTogZmFsc2VcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJnb25BcHBDb3VudChjb3VudDpudW1iZXIpIHtcbiAgICBpZiAoY291bnQgPiBtYXhBY3RpdmVBcHBzKSB7XG4gICAgICAgIG1heEFjdGl2ZUFwcHMgPSBjb3VudDtcbiAgICAgICAgaWYgKGNvdW50ID4gMSkge1xuICAgICAgICAgICAgbG9nQWN0aXZlQXBwQ291bnQoY291bnQpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlSW5zdGFsbGVkUmVhbGl0eUNvdW50KGNvdW50Om51bWJlcikge1xuICAgIGlmIChjb3VudCA+IG1heEluc3RhbGxlZFJlYWxpdGllcykge1xuICAgICAgICBtYXhJbnN0YWxsZWRSZWFsaXRpZXMgPSBjb3VudDtcbiAgICAgICAgaWYgKGNvdW50ID4gMSkge1xuICAgICAgICAgICAgbG9nSW5zdGFsbGVkUmVhbGl0eUNvdW50KGNvdW50KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUN1cnJlbnRSZWFsaXR5VXJpKHVyaTpzdHJpbmcpIHtcbiAgICBjdXJyZW50UmVhbGl0eVVyaSA9IHVyaTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWxpdHlNYW51YWxseUNoYW5nZWQodXJpOnN0cmluZykge1xuICAgIGlmICh1cmkgIT0gY3VycmVudFJlYWxpdHlVcmkpIHtcbiAgICAgICAgbG9nUmVhbGl0eU1hbnVhbGx5Q2hhbmdlZCgpO1xuICAgIH1cbn1cblxuYXBwVmlld01vZGVsLnJlYWR5LnRoZW4oKCk9PntcbiAgICBpZiAoaXNGaXJzdExvYWQpIHtcbiAgICAgICAgbG9nQXBwU3RhcnQoKTtcblxuICAgICAgICBhcHBWaWV3TW9kZWwuYXJnb24ucHJvdmlkZXIuZm9jdXMuc2Vzc2lvbkZvY3VzRXZlbnQuYWRkRXZlbnRMaXN0ZW5lcigoe2N1cnJlbnR9KT0+e1xuICAgICAgICAgICAgaWYgKGN1cnJlbnQgJiYgY3VycmVudC51cmkgIT0gXCJhcmdvbjptYW5hZ2VyXCIpIHtcbiAgICAgICAgICAgICAgICBsb2dBcHBGb2N1cyhjdXJyZW50LnVyaSk7XG4gICAgICAgICAgICAgICAgY3VycmVudC5jbG9zZUV2ZW50LmFkZEV2ZW50TGlzdGVuZXIoKCkgPT4geyBjbGVhckFwcEZvY3VzKCk7IH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjbGVhckFwcEZvY3VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn0pO1xuXG5hcHBWaWV3TW9kZWwub24oJ3Byb3BlcnR5Q2hhbmdlJywgKGV2dDpQcm9wZXJ0eUNoYW5nZURhdGEpPT57XG4gICAgaWYgKGV2dC5wcm9wZXJ0eU5hbWUgPT09ICdjdXJyZW50VXJpJykge1xuICAgICAgICAvLyBVc2VyIG5lZWRzIHRvIHN0YXkgb24gYSBwYWdlIGZvciBhIGZldyBzZWNvbmRzIGZvciBpdCB0byBjb3VudCBhcyBhIHBhZ2UgbG9hZFxuICAgICAgICAvLyBUaGlzIHdheSByZWRpcmVjdHMgYW5kIGFjY2lkZW50YWwgY2xpY2tzIGFyZW4ndCBsb2dnZWRcbiAgICAgICAgY2xlYXJUaW1lb3V0KHBhZ2VMb2FkVGltZXJJZCk7XG4gICAgICAgIGlmIChhcHBWaWV3TW9kZWwuY3VycmVudFVyaSkge1xuICAgICAgICAgICAgcGFnZUxvYWRUaW1lcklkID0gc2V0VGltZW91dCgoKT0+e1xuICAgICAgICAgICAgICAgIGxvZ1BhZ2VMb2FkKGFwcFZpZXdNb2RlbC5jdXJyZW50VXJpKTtcbiAgICAgICAgICAgIH0sIDMwMDApO1xuICAgICAgICB9XG4gICAgfVxufSk7XG5cbmFwcGxpY2F0aW9uLm9uKGFwcGxpY2F0aW9uLnJlc3VtZUV2ZW50LCAoKT0+IHtcbiAgICBpZiAoIWlzRmlyc3RMb2FkKSB7XG4gICAgICAgIGxvZ0FwcFJlc3VtZSgpO1xuICAgIH1cbn0pO1xuXG5hcHBsaWNhdGlvbi5vbihhcHBsaWNhdGlvbi5zdXNwZW5kRXZlbnQsICgpPT4ge1xuICAgIGlzRmlyc3RMb2FkID0gZmFsc2U7XG4gICAgY2xlYXJBcHBGb2N1cygpO1xufSk7XG5cblxuZnVuY3Rpb24gbG9nQXBwU3RhcnQoKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmxvZ0V2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiQXBwIFN0YXJ0XCIsXG4gICAgICAgIGFjdGlvbjogYXBwVmlld01vZGVsLmxhdW5jaGVkRnJvbVVybCA/IFwiVVJMIExhdW5jaFwiIDogXCJVc2VyIExhdW5jaFwiLFxuICAgICAgICBsYWJlbDogYXBwbGljYXRpb24uaW9zID8gXCJpT1NcIiA6IFwiQW5kcm9pZFwiLFxuICAgICAgICB2YWx1ZTogMVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBsb2dBcHBSZXN1bWUoKSB7XG4gICAgZ29vZ2xlQW5hbHl0aWNzLmxvZ0V2ZW50KHtcbiAgICAgICAgY2F0ZWdvcnk6IFwiQXBwIFJlc3VtZVwiLFxuICAgICAgICBhY3Rpb246IGFwcFZpZXdNb2RlbC5sYXVuY2hlZEZyb21VcmwgPyBcIlVSTCBMYXVuY2hcIiA6IFwiVXNlciBMYXVuY2hcIixcbiAgICAgICAgbGFiZWw6IGFwcGxpY2F0aW9uLmlvcyA/IFwiaU9TXCIgOiBcIkFuZHJvaWRcIixcbiAgICAgICAgdmFsdWU6IDFcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9nUGFnZUxvYWQodXJsOiBzdHJpbmcpIHtcbiAgICB2YXIgdHlwZSA9IFwiUGFnZSBMb2FkZWQgKG90aGVyKVwiO1xuICAgIGlmICh1cmwuaW5jbHVkZXMoXCJhcmdvbmpzLmlvXCIpKSB7XG4gICAgICAgIHR5cGUgPSBcIlBhZ2UgTG9hZGVkIChhcmdvbmpzLmlvKVwiO1xuICAgIH0gZWxzZSBpZiAodXJsLmluY2x1ZGVzKFwiZ29vZ2xlLmNvbS9zZWFyY2hcIikpIHtcbiAgICAgICAgdHlwZSA9IFwiR29vZ2xlIFNlYXJjaFwiO1xuICAgIH1cbiAgICBcbiAgICBnb29nbGVBbmFseXRpY3MubG9nRXZlbnQoe1xuICAgICAgICBjYXRlZ29yeTogXCJQYWdlIExvYWRcIixcbiAgICAgICAgYWN0aW9uOiB0eXBlLFxuICAgICAgICBsYWJlbDogYXBwbGljYXRpb24uaW9zID8gXCJpT1NcIiA6IFwiQW5kcm9pZFwiLFxuICAgICAgICB2YWx1ZTogMVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBsb2dBcHBGb2N1cyh1cmw6IHN0cmluZykge1xuICAgIHZhciB0eXBlID0gXCJBcHAgRm9jdXMgKG90aGVyKVwiO1xuICAgIGlmICh1cmwuaW5jbHVkZXMoXCJhcmdvbmpzLmlvXCIpKSB7XG4gICAgICAgIHR5cGUgPSBcIkFwcCBGb2N1cyAoYXJnb25qcy5pbylcIjtcbiAgICB9XG5cbiAgICBpZiAoZm9jdXNUaW1lckFjdGl2ZSkgZ29vZ2xlQW5hbHl0aWNzLnN0b3BUaW1lcihhcHBGb2N1c1RpbWVySUQpO1xuICAgIGdvb2dsZUFuYWx5dGljcy5zdGFydFRpbWVyKGFwcEZvY3VzVGltZXJJRCwge1xuICAgICAgICBjYXRlZ29yeTogXCJBcHAgRm9jdXNcIixcbiAgICAgICAgbmFtZTogdHlwZSxcbiAgICAgICAgbGFiZWw6IChhcHBsaWNhdGlvbi5pb3MpID8gXCJpT1NcIiA6IFwiQW5kcm9pZFwiXG4gICAgfSk7XG4gICAgZm9jdXNUaW1lckFjdGl2ZSA9IHRydWU7XG59XG5cbmZ1bmN0aW9uIGNsZWFyQXBwRm9jdXMoKSB7XG4gICAgaWYgKGZvY3VzVGltZXJBY3RpdmUpIGdvb2dsZUFuYWx5dGljcy5zdG9wVGltZXIoYXBwRm9jdXNUaW1lcklEKTtcbiAgICBmb2N1c1RpbWVyQWN0aXZlID0gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGxvZ0FjdGl2ZUFwcENvdW50KGNvdW50OiBudW1iZXIpIHtcbiAgICBnb29nbGVBbmFseXRpY3MubG9nRXZlbnQoe1xuICAgICAgICBjYXRlZ29yeTogXCJNdWx0aXBsZSBBcHBzXCIsXG4gICAgICAgIGFjdGlvbjogKGNvdW50ICsgXCIgQXBwcyBPcGVuXCIpLFxuICAgICAgICBsYWJlbDogYXBwbGljYXRpb24uaW9zID8gXCJpT1NcIiA6IFwiQW5kcm9pZFwiLFxuICAgICAgICB2YWx1ZTogY291bnRcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9nSW5zdGFsbGVkUmVhbGl0eUNvdW50KGNvdW50OiBudW1iZXIpIHtcbiAgICBnb29nbGVBbmFseXRpY3MubG9nRXZlbnQoe1xuICAgICAgICBjYXRlZ29yeTogXCJNdWx0aXBsZSBSZWFsaXRpZXNcIixcbiAgICAgICAgYWN0aW9uOiAoY291bnQgKyBcIiBSZWFsaXRpZXMgSW5zdGFsbGVkXCIpLFxuICAgICAgICBsYWJlbDogYXBwbGljYXRpb24uaW9zID8gXCJpT1NcIiA6IFwiQW5kcm9pZFwiLFxuICAgICAgICB2YWx1ZTogY291bnRcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9nUmVhbGl0eU1hbnVhbGx5Q2hhbmdlZCgpIHtcbiAgICBnb29nbGVBbmFseXRpY3MubG9nRXZlbnQoe1xuICAgICAgICBjYXRlZ29yeTogXCJSZWFsaXR5IENoYW5nZVwiLFxuICAgICAgICBhY3Rpb246IFwiTWFudWFsIFJlYWxpdHkgQ2hhbmdlXCIsXG4gICAgICAgIGxhYmVsOiBhcHBsaWNhdGlvbi5pb3MgPyBcImlPU1wiIDogXCJBbmRyb2lkXCIsXG4gICAgICAgIHZhbHVlOiAxXG4gICAgfSk7XG59Il19